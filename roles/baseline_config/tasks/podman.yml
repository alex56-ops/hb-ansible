---
- name: Install Podman and dependencies
  ansible.builtin.apt:
    name:
      - podman
      - podman-compose
      - slirp4netns
      - uidmap
    state: present
    update_cache: true

- name: Configure Podman registries
  ansible.builtin.template:
    src: podman_registries.conf.j2
    dest: /etc/containers/registries.conf
    owner: root
    group: root
    mode: "0644"

- name: Configure Podman storage
  ansible.builtin.template:
    src: podman_storage.conf.j2
    dest: /etc/containers/storage.conf
    owner: root
    group: root
    mode: "0644"

- name: Configure subuid ranges for admin users
  ansible.builtin.lineinfile:
    path: /etc/subuid
    regexp: "^{{ item.name }}:"
    line: "{{ item.name }}:100000:65536"
    create: true
    owner: root
    group: root
    mode: "0644"
  loop: "{{ baseline_config_admin_users }}"
  loop_control:
    label: "{{ item.name }}"

- name: Configure subgid ranges for admin users
  ansible.builtin.lineinfile:
    path: /etc/subgid
    regexp: "^{{ item.name }}:"
    line: "{{ item.name }}:100000:65536"
    create: true
    owner: root
    group: root
    mode: "0644"
  loop: "{{ baseline_config_admin_users }}"
  loop_control:
    label: "{{ item.name }}"

- name: Enable linger for admin users
  ansible.builtin.command:
    cmd: "loginctl enable-linger {{ item.name }}"
    creates: "/var/lib/systemd/linger/{{ item.name }}"
  loop: "{{ baseline_config_admin_users }}"
  loop_control:
    label: "{{ item.name }}"
